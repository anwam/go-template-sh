.PHONY: all build run test lint clean docker docker-up docker-down generate tidy fmt vet

# Project settings
BINARY_NAME={{.ProjectName}}
MAIN_PATH=./cmd/$(BINARY_NAME)
GO_VERSION={{.GoVersion}}

all: lint test build

# Build the application
build:
	@echo "Building..."
	@go build -o bin/$(BINARY_NAME) $(MAIN_PATH)

# Build production binary
build-prod:
	@echo "Building production binary..."
	@CGO_ENABLED=0 go build -ldflags="-s -w" -trimpath -o bin/$(BINARY_NAME) $(MAIN_PATH)

# Run the application
run: build
	@echo "Running..."
	@./bin/$(BINARY_NAME)

# Run with hot reload (requires air: go install github.com/air-verse/air@latest)
dev:
	@air

# Run tests
test:
	@echo "Running tests..."
	@go test -v -race -coverprofile=coverage.out ./...

# Run tests with coverage report
test-coverage: test
	@go tool cover -html=coverage.out -o coverage.html
	@echo "Coverage report generated: coverage.html"

# Run unit tests only
test-unit:
	@echo "Running unit tests..."
	@go test -v -short -race ./...

# Run integration tests only
test-integration:
	@echo "Running integration tests..."
	@go test -v -run Integration ./...

# Run linter (requires golangci-lint)
lint:
	@echo "Linting..."
	@golangci-lint run ./...

# Format code
fmt:
	@echo "Formatting..."
	@go fmt ./...
	@goimports -w .

# Vet code
vet:
	@echo "Vetting..."
	@go vet ./...

# Clean build artifacts
clean:
	@echo "Cleaning..."
	@rm -rf bin/
	@rm -f coverage.out coverage.html

# Tidy dependencies
tidy:
	@echo "Tidying dependencies..."
	@go mod tidy

# Generate mocks and other code
generate:
	@echo "Generating..."
	@go generate ./...

# Generate mocks (alias for generate)
generate-mocks: generate

# Install development tools
install-tools:
	@echo "Installing development tools..."
	@go install go.uber.org/mock/mockgen@latest
	@go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@go install github.com/air-verse/air@latest
	@go install golang.org/x/tools/cmd/goimports@latest
{{if .IncludeDocker}}
# Docker commands
docker:
	@echo "Building Docker image..."
	@docker build -t $(BINARY_NAME):latest .

docker-up:
	@echo "Starting Docker services..."
	@docker-compose up -d

docker-down:
	@echo "Stopping Docker services..."
	@docker-compose down

docker-logs:
	@echo "Showing Docker logs..."
	@docker-compose logs -f
{{end}}
# Help
help:
	@echo "Available targets:"
	@echo "  all          - Lint, test, and build"
	@echo "  build        - Build the application"
	@echo "  build-prod   - Build production binary"
	@echo "  run          - Build and run the application"
	@echo "  dev          - Run with hot reload (requires air)"
	@echo "  test         - Run tests"
	@echo "  test-coverage - Run tests with coverage report"
	@echo "  test-unit    - Run unit tests only"
	@echo "  test-integration - Run integration tests only"
	@echo "  lint         - Run linter"
	@echo "  fmt          - Format code"
	@echo "  vet          - Vet code"
	@echo "  clean        - Clean build artifacts"
	@echo "  tidy         - Tidy dependencies"
	@echo "  generate     - Generate mocks and code"
	@echo "  generate-mocks - Generate mocks (alias)"
	@echo "  install-tools - Install development tools"
{{- if .IncludeDocker}}
	@echo "  docker       - Build Docker image"
	@echo "  docker-up    - Start Docker services"
	@echo "  docker-down  - Stop Docker services"
	@echo "  docker-logs  - Show Docker logs"
{{- end}}
	@echo "  help         - Show this help"
